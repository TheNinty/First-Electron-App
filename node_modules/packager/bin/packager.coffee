exec = require('child_process').exec
require 'colorodo'
argv = require('optimist').argv
async = require 'async'

config=
	env: 'development'
	verbose: no
	colors: yes

positionOfCommand = 1

if argv.h or argv.help
	console.log "Usage: package [options] [command]"
	do console.log
	console.log "Options:"
	console.log "\t-h, --help - print this help"
	console.log "\t-e, --environment - specify environment"
	console.log "\t-v, --verbose - be more talkative"
	console.log "\t-n, --no-colors - no colors in the output"
	do console.log
	console.log "Commands:"
	console.log "\tinit - create empty Npmfile in the current directory"
	console.log "\tinstall - install all modules, which are specified in Npmfile"
	console.log "\tlist - list all modules, which are specified in Npmfile"
	do process.exit

if argv.e or argv.environment
	config.env = argv.e or argv.environment
	if 'production' != config.env and 'development' != config.env and 'testing' != config.env
		console.log "[#{ "error".color('red') }] You should specify environment."
		do process.exit

if argv.v or argv.verbose
	config.verbose = yes

if argv.n or argv.colors is false
	config.colors = no

command = argv._[0]
if not command or ('init' != command and 'install' != command and 'list' != command)
	console.log "[#{ "error".color('red') }] You should specify command."
	do process.exit

packages = []
package = (name, version) ->
	packages.push if version then "#{ name }@#{ version }" else name

env = (name, packages) ->
	do packages if config.env is name

commands=
	init: ->
		exec 'touch Npmfile'
		console.log "[#{ "success".color() }] Npmfile created." if config.verbose
	install: ->
		exec 'coffee -cbp Npmfile', (err, stdout) ->
			eval stdout # dirty, I know
			async.forEachSeries packages, (package, nextPackage) ->
				exec "npm install #{ package }", (err, stdout, stderr)->
					if config.verbose
						console.log if err then "[#{ "error".color('red') }] #{ package } not installed." else "[#{ "success".color() }] #{ package } installed."
					do nextPackage
			, ->
				console.log "[#{ "success".color() }] Finished." if config.verbose
	list: ->
		exec 'coffee -cbp Npmfile', (err, stdout) ->
			eval stdout # I'm sorry, again
			async.forEachSeries packages, (package, nextPackage) ->
				console.log "[#{ "package".color('yellow') }] #{ package }"
				do nextPackage
			, ->

do commands[command]		